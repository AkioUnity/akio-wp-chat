/*
 Live Chat X, by Akio.

 Heino, All rights reserved.
 This  is  commercial  software,  only  users  who have purchased a valid
 license  and  accept  to the terms of the  License Agreement can install
 and use this program.
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var a=0;return function(b){return $jscomp.SYMBOL_PREFIX+(b||"")+a++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.makeIterator=function(a){$jscomp.initSymbolIterator();$jscomp.initSymbol();$jscomp.initSymbolIterator();var b=a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};var indexOf;
indexOf="function"===typeof Array.prototype.indexOf?function(a,b){return a.indexOf(b)}:function(a,b){for(var c=0,d=a.length,e=-1,f=!1;c<d&&!f;)a[c]===b&&(e=c,f=!0),c++;return e};var nBirdEvents=function(){this.events={}};nBirdEvents.prototype.on=function(a,b){"object"!==typeof this.events[a]&&(this.events[a]=[]);this.events[a].push(b)};nBirdEvents.prototype.off=function(a,b){if("object"===typeof this.events[a]){var c=indexOf(this.events[a],b);-1<c&&this.events[a].splice(c,1)}};
nBirdEvents.prototype.emit=function(a){var b,c=[].slice.call(arguments,1);if("object"===typeof this.events[a]){var d=this.events[a].slice();var e=d.length;for(b=0;b<e;b++)d[b].apply(this,c)}};nBirdEvents.prototype.once=function(a,b){this.on(a,function d(){this.off(a,d);b.apply(this,arguments)})};var NBird=function(){};NBird.isEmail=function(a){return/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(a)};
NBird.time=function(a,b){var c=new Date(a),d={Y:c.getFullYear(),m:c.getMonth()+1,d:c.getDate(),H:c.getHours(),i:c.getMinutes(),s:c.getSeconds()};1===d.H.toString().length&&(d.H="0"+d.H);1===d.i.toString().length&&(d.i="0"+d.i);return b=b.replace(/Y|m|d|H|i|s/gi,function(a){return d[a]})};
NBird.timeago=function(a,b){var c=function(a,c){var d=b[a]&&b[a].replace(/%d/i,Math.abs(Math.round(c)));"seconds"!==a&&(d+=b.suffix);return d},d=function(a){if(a){a=a.replace(/\.\d+/,"");a=a.replace(/-/,"/").replace(/-/,"/");a=a.replace(/T/," ").replace(/Z/," UTC");a=a.replace(/([\+\-]\d\d):?(\d\d)/," $1$2");a=new Date(1E3*a||a);a=.001*((new Date).getTime()-a)>>0;var d=a/60,e=d/60,f=e/24,h=f/365;return b.prefix+(45>a&&c("seconds",a)||90>a&&c("minute",1)||45>d&&c("minutes",d)||90>d&&c("hour",1)||24>
e&&c("hours",e)||42>e&&c("day",1)||30>f&&c("days",f)||45>f&&c("month",1)||365>f&&c("months",f/30)||1.5>h&&c("year",1)||c("years",h))}};if(a)a.innerHTML=d(a.getAttribute("datetime"));else{var e=document.getElementsByClassName("lcx-timeago"),f;for(f in e)a=e[f],"object"===typeof a&&(a.innerHTML=d(a.getAttribute("datetime")))}};NBird.randInt=function(a,b){return Math.floor(Math.random()*(b-a+1))+a};NBird.delObj=function(a){"string"===typeof a&&(a=document.getElementById(a));a&&a.parentNode.removeChild(a)};
NBird.insertAfter=function(a,b){b.parentNode.insertBefore(a,b.nextSibling)};NBird.replace=function(a,b,c){var d;for(d in b){var e=c?"{"+d+"}":d;a=a.replace(new RegExp(NBird._escRgx(e),"g"),b[d])}return a};NBird._escRgx=function(a){return a.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")};
NBird.replaceAll=function(a,b,c,d){d=void 0===d?"":d;for(var e in b)a=a.replace(new RegExp(NBird._escRgx("{__"+d+e+"}"),"g"),b[e]),c&&(a=a.replace(new RegExp(NBird._escRgx("{"+d+e+"}"),"g"),'<span class="_nbird-tpl-'+e+" _nbird-tpl-"+d+c+"-"+e+'">'+b[e]+"</span>"));return a};NBird.sanitizeMsg=function(a){a=a.replace(/<\/?p[^>]*>/g,"");return a=a.replace(/<\/?span[^>]*>/g,"")};
NBird.renderMsg=function(a){a=a.replace(/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,'<a href="$1" target="_blank">$1</a>');a=a.replace(/(^|[^\/])(www\.[\S]+(\b|$))/gim,'$1<a href="http://$2" target="_blank">$2</a>');return a=a.replace(/(([a-zA-Z0-9\-_\.])+@[a-zA-Z_]+?(\.[a-zA-Z]{2,6})+)/gim,'<a href="mailto:$1">$1</a>')};NBird.play=function(a,b){var c=(new Audio(b+"/assets/sounds/"+a+".mp3")).play();c&&"undefined"!==typeof Promise&&c instanceof Promise&&c["catch"](function(){})};
NBird.refreshTags=function(a,b,c){c=void 0===c?"":c;var d,e;for(e in b)if(d=document.getElementsByClassName("_nbird-tpl-"+c+a+"-"+e))for(var f=0;f<d.length;f++)d[f].innerHTML=b[e]};NBird.clearTags=function(a,b){return a=a.replace(new RegExp("{__"+b+"(.*?)}","gm"),"")};NBird.selAll=function(a){var b=document.createRange();b.selectNodeContents(a);a=window.getSelection();a.removeAllRanges();a.addRange(b)};
NBird.idealTextColor=function(a){a=this.convertToRGB(a);return 105>255-(.299*a.R+.587*a.G+.114*a.B)?"#333":"#fff"};NBird.convertToRGB=function(a){var b=a.substring(1,3),c=a.substring(3,5);a=a.substring(5,7);return{R:parseInt(b,16),G:parseInt(c,16),B:parseInt(a,16)}};NBird.scrollDown=function(a){a.scrollTop=a.scrollHeight};
NBird.post=function(a,b,c,d){b.mode=a;b.action=b.action||"lcx_action";b._ajax_nonce=c.nonce;var e=new XMLHttpRequest;a=new FormData;e.open("POST",c.url,!0);e.onreadystatechange=function(){4==e.readyState&&(200==e.status?d&&d(JSON.parse(e.responseText)):d&&d(null))};for(var f in b)a.append(f,b[f]);e.send(a)};NBird.get=function(a,b,c){var d=new XMLHttpRequest;d.open("GET",a,!0);d.onreadystatechange=function(){4==d.readyState&&(200==d.status?c&&c(JSON.parse(d.responseText)):c&&c(null))};d.send()};
var NBirdDB=function(a){this.opts=a;this.event=lcx_events;this.auth=this.db="";this._isFirstConn=!0;this._uid=localStorage.getItem("nbird-uid")||"";this._refSess=this._refUser=this._sess=this._user="";this._listen={chats:{},users:{}};this._archives={};this.$_user={};this.$_users={};this.$_onlineOps={};this.$_msgs={};this.$_chats={};this.$_chatReqs={};this.$_members={}};
NBirdDB.prototype.init=function(){var a=this;firebase.initializeApp({apiKey:this.opts.db.apiKey,authDomain:this.opts.db.authDomain,databaseURL:this.opts.db.databaseURL});this.db=firebase.database();this.auth=firebase.auth();this.db.ref(".info/connected").on("value",function(b){!0===b.val()?(a._isFirstConn=!1,a._onConnect()):a._onDisconnect("networkError")});this.auth.onAuthStateChanged(function(b){a._onAuthState(b)})};
NBirdDB.prototype.verify=function(){var a=this;this.db.ref("db_version").once("value").then(function(b){b.exists()?Number(b.val())<Number(a.opts.dbVersion)&&a._onSetupDB():a._onSetupDB()})};NBirdDB.prototype.setup=function(a){var b={};b.db_version=this.opts.dbVersion;b._livechat=null;this.db.ref().update(b).then(a)};NBirdDB.prototype.updateProfile=function(a,b){this._user.updateProfile({displayName:a.name||"",photoURL:a.photoURL||""});this._refUser.update(a);this.db.ref("operators/"+this._uid).update(a).then(b)};
NBirdDB.prototype.updateEmail=function(a,b){this._user.updateEmail(a).then(b)};NBirdDB.prototype.resetUserData=function(){this._refUser&&this._refUser.child("lastSeen").onDisconnect().cancel();this._uid=this._user=this._refUser="";localStorage.removeItem("nbird-uid");localStorage.removeItem("nbird-accessToken")};
NBirdDB.prototype.getNewCaseNo=function(a){var b=this;this.db.ref("caseNo").transaction(function(a){return++a},function(c,d,e){c||(c=e.val(),b.db.ref("users/"+b._uid+"/identity/lastCaseNo").set(c).then(a.bind(null,c)))})};
NBirdDB.prototype.createIdentity=function(a){var b=this;NBird.randInt(0,145);NBird.randInt(0,232);var c={};this.db.ref("caseNo").transaction(function(a){c.lastCaseNo=a+1;return++a}).then(function(){return b.db.ref("_livechat/colors/"+NBird.randInt(0,145)).once("value")}).then(function(a){a=a.val();var d=Object.keys(a)[0];c.color={name:d,hex:a[d]};return b.db.ref("_livechat/animals/"+NBird.randInt(0,232)).once("value")}).then(function(d){c.animal=d.val();c.nickname=b.opts.user.name||c.color.name+" "+
c.animal;a(c)})};NBirdDB.prototype.createUser=function(a,b,c){this.db.ref("users/"+a).set(b).then(c)};NBirdDB.prototype.updateUser=function(a,b,c){this.db.ref("users/"+a).update(b).then(c)};NBirdDB.prototype.renameUser=function(a,b,c){b&&this.db.ref("users/"+a+"/nickname").set(b).then(c)};
NBirdDB.prototype.signin=function(a,b){var c=this;switch(a){case "custom":this.auth.signInWithCustomToken(b)["catch"](this._onAuthErr.bind(this));break;case "google":var d=new firebase.auth.GoogleAuthProvider;d.addScope("https://www.googleapis.com/auth/firebase");d.addScope("https://www.googleapis.com/auth/cloud-platform");d.setCustomParameters({login_hint:this.opts.db.email});firebase.auth().signInWithPopup(d).then(function(a){var b=a.additionalUserInfo;localStorage.setItem("nbird-accessToken",a.credential.accessToken);
b.isNewUser?c.createUser(a.user.uid,{name:b.profile.given_name,photoURL:b.profile.picture,email:b.profile.email}):c.updateUser(a.user.uid,{email:b.profile.email})})["catch"](function(a){c._onAuthErr(a)});break;case "anonymous":this.auth.signInAnonymously()["catch"](this._onAuthErr.bind(this))}};NBirdDB.prototype.signout=function(){var a=this,b={};b["users/"+this._uid+"/sessions/"+this.opts.platform]=null;b["onlineOps/"+this._uid]=null;this.resetUserData();this.db.ref().update(b).then(function(){return a.auth.signOut()})};
NBirdDB.prototype.connect=function(){this.db.goOnline()};NBirdDB.prototype.disconnect=function(){this.db.goOffline()};NBirdDB.prototype.toggleSignin=function(a,b){this._user?this.signout():this.signin(a,b)};NBirdDB.prototype.toggleOnline=function(a){var b=this.db.ref("onlineOps/"+this._uid),c=this.db.ref("operators/"+this._uid+"/lastOnline");a=a?!0:null;b.set(a);a||c.set(firebase.database.ServerValue.TIMESTAMP);a&&(b.onDisconnect().remove(),c.onDisconnect().set(firebase.database.ServerValue.TIMESTAMP))};
NBirdDB.prototype.startSession=function(){this._sess={started:firebase.database.ServerValue.TIMESTAMP};this._refSess.set(this._sess);this._refSess.onDisconnect().remove();this._refSess.off();this._refSess.on("child_removed",this._onEndSession.bind(this))};NBirdDB.prototype.endSession=function(a){this._refSess.remove().then(a)};
NBirdDB.prototype.listenOpEvents=function(){var a=this.db.ref("onlineOps"),b=this.db.ref("users").orderByChild("lastSeen"),c=this.db.ref("chats").limitToLast(100).orderByChild("archived").equalTo(null),d=this.db.ref("chats").orderByChild("archived").equalTo(!0);a.off();a.on("child_added",this._onNewOp.bind(this));a.on("child_removed",this._onDeleteOp.bind(this));b.off();b.on("child_added",this._onNewUser.bind(this));b.on("child_changed",this._onUpdateUser.bind(this));b.on("child_removed",this._onDeleteUser.bind(this));
c.off();c.on("child_added",this._onNewChat.bind(this));c.on("child_changed",this._onUpdateChat.bind(this));c.on("child_removed",this._onDeleteChat.bind(this));d.off();d.on("child_added",this._onNewArchivedChat.bind(this));d.on("child_changed",this._onUpdateArchivedChat.bind(this));d.on("child_removed",this._onDeleteArchivedChat.bind(this))};NBirdDB.prototype.getOnlineOps=function(a){this.db.ref("onlineOps").once("value").then(function(b){a(b.val())})};
NBirdDB.prototype.startChat=function(a,b,c){var d=this,e=this.db.ref("chats").push().key,f={};f["chats/"+e]={name:a.name||null,subject:a.msg||null,lastMsg:a.msg||null,date:firebase.database.ServerValue.TIMESTAMP,visitorid:this._uid,caseNo:a.caseNo,status:"init",type:"support"};f["members/"+e+"/"+this._uid]={chatid:e};this.db.ref().update(f).then(function(){d.listenChat(e,!0);a.msg&&d.pushMsg(e,a.msg);b&&b(e)})["catch"](c)};NBirdDB.prototype.updateChat=function(a,b,c){this.db.ref("chats/"+a).update(b).then(c)};
NBirdDB.prototype.deleteChat=function(a,b){var c={},d=this.$_chats[a];c["chats/"+a]=null;c["messages/"+a]=null;c["members/"+a]=null;c["users/"+this._uid+"/chats/"+a]=null;c["users/"+d.visitorid+"/chatsAsVisitor/"+a]=null;this.db.ref().update(c)};
NBirdDB.prototype.listenChat=function(a,b,c){if(!(a in this._listen.chats)){this._listen.chats[a]=!0;this.$_msgs[a]={};this.$_members[a]={};if(b)this.db.ref("chats/"+a).orderByChild("archived").equalTo(null).on("value",this._onSingleChatUpdate.bind(this));b=this.db.ref("messages/"+a);b.on("child_added",this._onNewMsg.bind(this));b.on("child_changed",this._onUpdateMsg.bind(this));b.on("child_removed",this._onDeleteMsg.bind(this));a=this.db.ref("members/"+a);a.on("child_added",this._onNewMember.bind(this));
a.on("child_changed",this._onUpdateMember.bind(this));a.on("child_removed",this._onDeleteMember.bind(this))}};NBirdDB.prototype.unlistenChat=function(a){this.db.ref("chats/"+a).off();this.db.ref("messages/"+a).off();this.db.ref("members/"+a).off();delete this._listen.chats[a];delete this.$_chats[a];delete this.$_msgs[a];delete this.$_members[a];this.$_chats||(this.$_chats={});this.$_msgs||(this.$_msgs={});this.$_members||(this.$_members={})};
NBirdDB.prototype.joinChat=function(a,b,c,d){var e=this.$_chats[a]||null;if(e){var f={};f["chats/"+a+"/status"]="open";b&&"init"===e.status?this.pushMsg(a,b,c,f):f=this.getJoinChatUpdates(a,f);this.db.ref().update(f).then(c)["catch"](d)}else d&&d()};NBirdDB.prototype.endChat=function(a,b){this.updateChat(a,{status:"close",endedAt:firebase.database.ServerValue.TIMESTAMP},b)};NBirdDB.prototype.readChat=function(a,b){a in this.$_chats&&this.db.ref("chats/"+a+"/lastReadByOp").set(firebase.database.ServerValue.TIMESTAMP).then(b)};
NBirdDB.prototype.pushMsg=function(a,b,c,d,e){var f={},h=this.db.ref("messages").push().key,g=this.$_user,l="frontend"===this.opts.platform?g.nickname:g.name;f["chats/"+a+"/lastMsg"]=b;f["messages/"+a+"/"+h]={chatid:a,date:firebase.database.ServerValue.TIMESTAMP,msg:b,name:l||"",photoURL:g.photoURL||"",uid:this._uid,platform:this.opts.platform};f["users/"+this._uid+"/lastSeen"]=firebase.database.ServerValue.TIMESTAMP;f=this.getJoinChatUpdates(a,f);if(d)for(var k in d)f[k]=d[k];this.db.ref().update(f).then(c)["catch"](e)};
NBirdDB.prototype.getJoinChatUpdates=function(a,b){if(!(this._uid in this.$_members)){b["members/"+a+"/"+this._uid]={chatid:a};var c=this.$_chats[a];c&&!c.opid&&"console"===this.opts.platform&&(b["chats/"+a+"/opid"]=this._uid,b["chats/"+a+"/lastReadByOp"]=firebase.database.ServerValue.TIMESTAMP)}return b};NBirdDB.prototype.getServerTime=function(a){this.db.ref(".info/serverTimeOffset").once("value",function(b){b=b.val();a((new Date).getTime()+b)})};NBirdDB.prototype._onSetupDB=function(){this.event.emit("setup")};
NBirdDB.prototype._onConnect=function(){this.event.emit("connect")};NBirdDB.prototype._onDisconnect=function(a){this.event.emit("disconnect",a)};
NBirdDB.prototype._onAuthState=function(a){var b=this;a?(this._uid=a.uid,this._user=this.auth.currentUser,this._refUser=this.db.ref("users/"+this._uid),this._refUser.once("value",function(c){b._refSess=b._refUser.child("sessions/"+b.opts.platform);if(b.opts.preventDuplicate&&c.hasChild("sessions/"+b.opts.platform))b.event.emit("duplicateSession",a);else{localStorage.setItem("nbird-uid",b._uid);b._refUser.off();b._refUser.on("value",b._onProfileUpdate.bind(b));if("frontend"===b.opts.platform){c=firebase.database.ServerValue.TIMESTAMP;
var d=b._refUser.child("lastSeen");d.set(c);d.onDisconnect().set(c)}b.startSession()}})):(this.resetUserData(),this._refreshReq&&window.location.reload(!0));this.event.emit("authState",a)};NBirdDB.prototype._onAuthErr=function(a){this.event.emit("authError",a)};NBirdDB.prototype._onEndSession=function(){this._sess="";this._uid&&this.event.emit("endSession")};NBirdDB.prototype._onProfileUpdate=function(a){this.$_user=a.val();this.event.emit("profile",a.key)};
NBirdDB.prototype._onNewUser=function(a,b){var c=a.key,d=a.val();this.$_users[c]=d;this.event.emit("newUser",c,d,b)};NBirdDB.prototype._onUpdateUser=function(a,b){var c=a.key,d=a.val();this.$_users[c]=d;this.event.emit("updateUser",c,d,b)};NBirdDB.prototype._onDeleteUser=function(a,b){delete this.$_users[a.key];this.$_users||(this.$_users={});this.event.emit("deleteUser",a.key,a.val(),b)};NBirdDB.prototype._onHandleUser=function(a){};
NBirdDB.prototype._onNewOp=function(a,b){this.$_onlineOps[a.key]=!0;this.event.emit("newOp",a.key,b)};NBirdDB.prototype._onDeleteOp=function(a,b){delete this.$_onlineOps[a.key];this.$_onlineOps||(this.$_onlineOps={});this.event.emit("deleteOp",a.key,b)};NBirdDB.prototype._onNewChat=function(a,b){var c=a.key,d=a.val();this.$_msgs[c]={};this.$_members[c]={};this.$_chats[c]=d;this.event.emit("newChat",c,d,b)};
NBirdDB.prototype._onUpdateChat=function(a,b){var c=a.key,d=a.val();this.$_chats[c]=d;this.event.emit("updateChat",c,d,b)};NBirdDB.prototype._onDeleteChat=function(a,b){this.unlistenChat(a.key);this.event.emit("deleteChat",a.key,a.val(),b)};NBirdDB.prototype._onSingleChatUpdate=function(a,b){var c="updateSingleChat",d=a.key,e=a.val();null===e?(delete this.$_chats[d],this.event.emit("deleteSingleChat",d,b)):(d in this.$_chats||(c="newSingleChat"),this.$_chats[d]=e,this.event.emit(c,d,e,b))};
NBirdDB.prototype._onNewArchivedChat=function(a,b){var c=a.val();c.caseNo&&(this._archives[a.key]=c,this.event.emit("newArchivedChat",a.key,c,b))};NBirdDB.prototype._onUpdateArchivedChat=function(a,b){a.key in this._archives?(this._archives[a.key]=a.val(),this.event.emit("updateArchivedChat",a.key,a.val(),b)):this._onNewArchivedChat(a,b)};NBirdDB.prototype._onDeleteArchivedChat=function(a,b){delete this._archives[a.key];this.event.emit("deleteArchivedChat",a.key,a.val(),b)};
NBirdDB.prototype._onNewMsg=function(a,b){var c=a.key,d=a.val(),e=this.$_chats[d.chatid].lastReadByOp||null;d.prevId=b;e<d.date&&(d.platform!==this.opts.platform||d.uid!==this._uid)&&(d.__unread=!0);this.$_msgs[d.chatid][c]=d;this.event.emit("newMsg",c,d,b)};NBirdDB.prototype._onUpdateMsg=function(a,b){var c=a.key,d=a.val();d.prevId=b;this.$_msgs[d.chatid][c]=d;this.event.emit("updateMsg",c,d,b)};
NBirdDB.prototype._onDeleteMsg=function(a,b){var c=a.val();this.$_msgs[c.chatid]&&delete this.$_msgs[c.chatid][a.key];this.event.emit("deleteMsg",a.key,c,b)};NBirdDB.prototype._onNewMember=function(a,b){var c=a.key,d=a.val();this.$_members[d.chatid][c]=d;this.event.emit("newMember",c,d,b)};NBirdDB.prototype._onUpdateMember=function(a,b){var c=a.key,d=a.val();this.$_members[d.chatid][c]=d;this.event.emit("updateMember",c,d,b)};
NBirdDB.prototype._onDeleteMember=function(a,b){var c=a.val();this.$_members[c.chatid]&&delete this.$_members[c.chatid][a.key];this.event.emit("deleteMember",a.key,c,b)};
var nightBird=function(a,b){var c=this;this.opts=a;this.str={conn:"Connecting...",reconn:"Reconnecting. Please wait...",noConn:"No internet connection!",connected:"Connected successfully!",reqFields:"Please fill out all required fields!",invEmail:"Email is invalid!",noEmail:"No email has provided yet.",edit:"Edit",you:"You",saving:"Saving...",saved:"Saved!",updated:"Updated successfully!",useHere:"Use here",errDuplicateSess:"Console is open in different window.",logsSent:"Chat transcript has sent to the visitor.",
errLogsSent:'Chat transcript couldn\'t be sent to the visitor. Please check your <a href="%s" target="_blank">email settings</a>.',cantEndChat:"This chat can't be ended!  Try refresh page.",newMsg:"%s says:",setupDB:'You should configure real-time database from <a href="%s">here</a>! \ud83d\ude0c',newChat:"%s started new chat!",confirmDelete:"This item will be DELETED immediately. You can't undo this action",time:{prefix:"",suffix:" ago",seconds:"less than a minute",minute:"about a minute",minutes:"%d minutes",
hour:"about an hour",hours:"about %d hours",day:"a day",days:"%d days",month:"about a month",months:"%d months",year:"about a year",years:"%d years"},timeShort:{prefix:"",suffix:"",seconds:"1m",minute:"1m",minutes:"%dm",hour:"1h",hours:"%dh",day:"1d",days:"%dd",month:"1mh",months:"%dmh",year:"1y",years:"%dy"}};if("object"===typeof b)for(var d in b)this.str[d]=b[d];this.event=lcx_events;this._wstate=!0;this._wtitle=document.title;this._win={};this._onlineVisitors={};this._unreadChats=[];this._countNewMsgs=
{};this._chatGroups={};this._chatid="";this._chatids={};this._listenItems=[];this._listenChats=[];this._newChats={};this._archiveList=this._chatsList=null;this.opts.autoinit&&document.addEventListener("DOMContentLoaded",function(){c.init()},!1)};
nightBird.prototype.init=function(){this.$console=document.getElementById("nbird-console");this.$signin=document.getElementById("nbird-signin");this.$toggleOnline=document.getElementById("nbird-toggle-online");this.$switchOnline=document.getElementById("nbird-switcher-online");this.$btnProfile=document.getElementById("nbird-profile");this.$btnSaveProfile=document.getElementById("btn-save-profile");this.$ntfs=document.getElementById("nbird-ntfs");this.$chats=document.getElementById("chats-list");this.$archivedChats=
document.getElementById("archived-chats-list");this.$win0=document.getElementById("win-0");this.$win1=document.getElementById("win-1");document.body.classList.add("folded");this.opts.db&&this.opts.db.apiKey?(this.db=lcx_db,this._dbEvents(),this._uiEvents(),this.db.init(),this.actions(document.getElementById("nbird-modal-profile"))):(this.$console.classList.add("disabled"),this.newNtf("error",this.str.setupDB.replace("%s",this.opts._optsurl+"#tab-realtime"),"setup"))};
nightBird.prototype.actions=function(a){var b=this;a=a||document;var c=a.querySelectorAll(".lcx-action");a=function(a){a.preventDefault();switch(this.getAttribute("data-action")){case "updateUserInput":a=this.parentNode.querySelector("."+this.getAttribute("href").substring(1));a.classList.toggle("d-hide");a.focus();a.addEventListener("keydown",function(a){var b=this;13===a.keyCode&&d(this.value,function(a){a&&b.classList.add("d-hide")})});break;case "resetOps":confirm("Are you sure you want to reset operators data?")&&
e()}return!1};var d=function(a,c){if(NBird.isEmail(a)){var d=b._win.rawid;d&&b.db.updateUser(d,{emailForNtf:a},function(){b.newNtf("success",b.str.updated,"userProfile",!0);c(!0)})}else b.newNtf("error",b.str.invEmail,"userProfile",!0)},e=function(){b.db.db.ref("onlineOps").set(null);b.db.db.ref("operators").set(null,function(){b.newNtf("error",b.str.reconn,"auth",!0);b.$console.classList.add("disabled");window.location.reload(!0);b.closeModals()})};if(c){c=$jscomp.makeIterator(c);for(var f=c.next();!f.done;f=
c.next())f.value.addEventListener("click",a,!1)}};
nightBird.prototype._uiEvents=function(){var a=this;this.$signin.addEventListener("click",function(b){b.preventDefault();this.disabled=!0;a.hideNtfGroup("auth");a.db.toggleSignin(a.opts.authMethod,a.opts.db.token)});this.$switchOnline&&this.$switchOnline.addEventListener("change",function(b){a.db.toggleOnline(this.checked)});var b=function(){a.db.setup(function(){window.location.reload(!0)})};document.getElementById("lcx-complete-install").addEventListener("click",function(a){a.preventDefault();this.disabled=
!0;this.classList.add("disabled");b()});this.$btnSaveProfile.addEventListener("click",function(b){b={};var c=document.getElementById("form-settings").elements;a.$btnSaveProfile.disabled=!0;for(var d=0,e;e=c[d++];)switch(e.nodeName){case "INPUT":case "TEXTAREA":b[e.name]="checkbox"===e.type?e.checked||null:e.value}a.saveSettings(b)});if("Notification"in window&&"granted"!==Notification.permission&&"denied"!==Notification.permission){var c=document.getElementById("lcx-ntf-alert");c.classList.remove("d-hide");
document.getElementById("lcx-activate-ntfs").addEventListener("click",function(b){Notification.requestPermission(function(b){"granted"===b&&(a.newDeskNtf("Hey","dn-activated","It is working! Good luck with sales :D","dn-activated",1E4),c.classList.add("d-hide"))})})}var d=document.getElementById("btn-endChat"),e=document.getElementById("btn-endChatWoMsg"),f=document.getElementById("cb-sendChatLogs"),h=document.getElementById("loader-endChat"),g=function(b,c,d){var e=a.db.$_users[c.visitorid]||{},
f=a.db.$_msgs[b],g=['<div class="chat-logs">'];if(!e&&!e.emailForNtf)return d(!1),!1;if(f)for(var h in f){var k=f[h];var y="frontend"===k.platform?a.str.you:k.name;g.push('<div class="msg-item"><span class="msg-time">',NBird.time(k.date,a.opts.dateFormat),':</span> <span class="msg-author">',y,':</span> <span class="msg-content">',NBird.renderMsg(k.msg),"</span></div>")}g.push("</div>");c.opid&&c.opid in a.db.$_users&&(c.opName=a.db.$_users[c.opid].name);NBird.post("sendChatLogs",{chatid:b,email:e.emailForNtf,
logs:g.join(""),caseNo:c.caseNo,opName:c.opName,opPhotoURL:c.opPhotoURL},a.opts.ajax,d)},l=function(){d.classList.remove("disabled");e.classList.remove("disabled");h.classList.add("d-hide")},k=function(b,c){a.db.endChat(b,function(){l();a.closeModals();if(c){var d=document.getElementById("f-closing-msg");0<d.value.length&&a.db.pushMsg(b,d.value)}})},m=function(b,c){!b.error&&b.chatid?(k(b.chatid,c),a.newNtf("success",a.str.logsSent,"logs",!0)):(a.newNtf("error",a.str.errLogsSent.replace("%s",a.opts._optsurl+
"#tab-site"),"logs",!0),l(),a.closeModals())};d.addEventListener("click",function(b){b.preventDefault();b=a._chatid||null;var c=a.db.$_chats[b];d.classList.add("disabled");e.classList.add("disabled");h.classList.remove("d-hide");if(!b||!c)return a.newNtf("error",a.str.cantEndChat,"endchat",!0),l(),a.closeModals(),!1;f.checked?g(b,c,function(a){m(a,!0)}):k(b,!0)});e.addEventListener("click",function(b){b.preventDefault();b=a._chatid||null;var c=a.db.$_chats[b];d.classList.add("disabled");e.classList.add("disabled");
h.classList.remove("d-hide");if(!b||!c)return a.newNtf("error",a.str.cantEndChat,"endchat",!0),l(),a.closeModals(),!1;f.checked?g(b,c,m):k(a._chatid)});var n=function(){NBird.timeago(null,a.str.timeShort);setTimeout(n,7E3)};n();window.addEventListener("focus",function(){a._wstate=!0});window.addEventListener("blur",function(){a._wstate=!1});this.closeModals();this.lists()};
nightBird.prototype.lists=function(){var a=document.querySelectorAll(".list-tabs a");if(a){a=$jscomp.makeIterator(a);for(var b=a.next();!b.done;b=a.next())b.value.addEventListener("click",function(a){a.preventDefault();a=this.getAttribute("href").substring(1);a=document.getElementById(a);var b=a.parentNode.querySelector(".list-tab-content.active");b&&b.classList.remove("active");a.classList.add("active");a=this.parentNode;(b=a.parentNode.querySelector(".active"))&&b.classList.remove("active");a.classList.add("active")})}};
nightBird.prototype.createItem=function(a,b,c){var d=a+"-item-"+b,e=document.createElement("li");e.id=d;e.setAttribute("data-id",b);e.setAttribute("data-status",c._status);"visitor"===a?(e.innerHTML=document.getElementById("chats-list-item-tpl").innerHTML,this._newChats[b]&&0<Object.keys(this._newChats[b]).length&&e.setAttribute("data-chat-status",c._status),e.querySelector(".lcx-name").innerText=c.nickname||c.name,e.querySelector(".lcx-timeago").setAttribute("datetime",Number(c.lastSeen/1E3)),e.querySelector(".lcx-item-link").setAttribute("href",
"#"+b),this.$chats.insertBefore(e,this.$chats.firstChild)):"archivedChat"===a&&(e.innerHTML=document.getElementById("archived-chats-list-item-tpl").innerHTML,e.querySelector(".lcx-name").innerText=c.nickname||c.name,e.querySelector(".lcx-caseNo").innerText=c.caseNo,e.querySelector(".lcx-timeago").setAttribute("datetime",Number(c.lastActive)),e.querySelector(".lcx-undo-link").setAttribute("href","#"+b),this.$archivedChats.insertBefore(e,this.$archivedChats.firstChild));this.event.emit("newItem-"+a,
e,b,c);return e};nightBird.prototype.updateItem=function(a,b,c){var d=document.getElementById(b);if(d){switch(a){case "newChat":d.setAttribute("data-chat-status","new");break;case "noNewChat":d.removeAttribute("data-chat-status")}this.event.emit("updateItem-"+a,d,b,c)}};nightBird.prototype.removeItem=function(a,b){var c=this._listenItems.indexOf(b);-1!==c&&this._listenItems.splice(c,1);switch(a){case "archivedChat":NBird.delObj("archivedChat-item-"+b)}};
nightBird.prototype.openWin=function(a,b,c,d){var e="nbird-win-"+b,f="nbird-sideWin-"+b,h=document.createElement("div"),g=document.createElement("div");document.getElementById("_win-tpl-"+a);h.id=e;h.className="window-"+a+" "+e+" window";h.innerHTML=c.main;this.$win0.innerHTML="";this.$win1.innerHTML="";this.$win0.appendChild(h);c.sidebar&&(g.id=f,g.className="window-"+a+" "+f+" window",g.innerHTML=c.sidebar,this.$win1.appendChild(g));this._win={id:e,rawid:b,type:a};d&&d(b);this._onOpenWin(a,b)};
nightBird.prototype.closeWin=function(){this._win={};this.$win0.innerHTML="";this.$win1.innerHTML=""};
nightBird.prototype.newNtf=function(a,b,c,d){var e="nbird-ntf-"+Math.floor(99999*Math.random())+1,f=document.createElement("div");a=document.getElementById("nbird-ntf-"+a).innerHTML;a=NBird.replaceAll(a,{msg:b});f.id=e;f.innerHTML=a;c&&(f.className="nbird-ntf nbird-ntf-"+c,this.hideNtfGroup(c));this.$ntfs.appendChild(f);f.querySelector(".close-btn").addEventListener("click",this.hideNtf.bind(null,e));d&&setTimeout(this.hideNtf.bind(null,e),this.opts.ntfDuration)};nightBird.prototype.hideNtf=function(a){NBird.delObj(a)};
nightBird.prototype.hideNtfGroup=function(a){if(a=document.getElementsByClassName("nbird-ntf-"+a))for(var b=0;b<a.length;b++)NBird.delObj(a[b])};nightBird.prototype.newDeskNtf=function(a,b,c,d,e,f){if(!this._wstate&&("Notification"in window||"granted"===Notification.permission)){var h=new Notification(a,{body:c,icon:f||this.opts.systemImage,tag:d||b});e&&setTimeout(h.close.bind(h),e);h.onclick=function(){h.close()};b&&NBird.play(b,this.opts._pluginurl)}};
nightBird.prototype.refreshChat=function(a,b,c){c=this.db.$_users[a]||{};var d=document.getElementById("visitor-item-"+a);for(e in this._chatGroups[a])this.db.listenChat(e);c._status=c.sessions&&c.sessions.frontend?"online":"offline";var e=d.getAttribute("data-status");e!==c._status&&"init"!==e&&(e=d.querySelector("a").classList.contains("active"),NBird.delObj(d),d=this.createItem("visitor",a,c),e&&d.querySelector("a").classList.add("active"),e=this._listenItems.indexOf(a),-1!==e&&this._listenItems.splice(e,
1));e=d.querySelector("a");c.lastSeen&&NBird.timeago(d.querySelector(".lcx-timeago"),this.str.timeShort);this.listenChatItem(a,e);this.$chats.querySelector("._no-item").classList.add("d-hide");this.refreshChatWin(b.id)};
nightBird.prototype.refreshChatWin=function(a){var b=this.db.$_chats[a],c=document.getElementById("chat-tab-item-"+a),d=document.getElementById("lcx-chat-tab-"+a);if(b&&this._chatid===a&&d){a=this.db.$_users[b.visitorid]||{};var e=this.$win0.querySelector(".win-footer"),f=this.$win0.querySelector(".ntf--op-talking"),h=this.$win0.querySelector(".ntf--ended-chat"),g=this.$win0.querySelector(".ntf--archived-chat"),l=d.querySelector(".btn-join-chat"),k=d.querySelector(".btn-end-chat"),m=d.querySelector(".btn-archive-chat");
d=d.querySelector(".btn-delete-chat");var n=document.getElementById("cb-sendChatLogs");this.$win0.querySelector(".lcx-user-meta-feedback .lcx-desc").classList.add("d-hide");this.$win0.querySelector(".lcx-user-meta-feedback .lcx--solved").classList.add("d-hide");this.$win0.querySelector(".lcx-user-meta-feedback .lcx--notsolved").classList.add("d-hide");"boolean"===typeof b.solved?(this.$win0.querySelector(".lcx-user-meta-feedback .lcx-desc").classList.add("d-hide"),b.solved?this.$win0.querySelector(".lcx-user-meta-feedback .lcx--solved").classList.remove("d-hide"):
this.$win0.querySelector(".lcx-user-meta-feedback .lcx--notsolved").classList.remove("d-hide")):this.$win0.querySelector(".lcx-user-meta-feedback .lcx-desc").classList.remove("d-hide");l.classList.remove("d-hide");k.classList.remove("d-hide");m.classList.remove("d-hide");d.classList.remove("d-hide");e.classList.add("d-hide");f.classList.add("d-hide");h.classList.add("d-hide");g.classList.add("d-hide");c.setAttribute("data-status",b.status);b.opid&&b.opid in this.db.$_users&&(b.opName=this.db.$_users[b.opid].name);
switch(b.status){case "init":k.classList.add("d-hide");break;case "open":l.classList.add("d-hide");e.classList.remove("d-hide");b.opid!==this.db._uid&&(f.innerHTML=NBird.replace(f.innerHTML,b,!0),f.classList.remove("d-hide"));break;case "close":h.classList.remove("d-hide"),l.classList.remove("d-hide"),k.classList.add("d-hide")}b.archived&&(g.classList.remove("d-hide"),l.classList.add("d-hide"),k.classList.add("d-hide"),m.classList.add("d-hide"));a.emailForNtf?(n.checked=!0,n.disabled=!1):(n.checked=
!1,n.disabled=!0)}};nightBird.prototype.readChat=function(a,b){var c=this._unreadChats.indexOf(a);if(-1!==c){var d=this.db.$_chats[a];d&&(this._unreadChats.splice(c,1),this.db.readChat(a,b),this._countNewMsgs[a]&&(this._countNewMsgs[a]=0),c=document.getElementById("visitor-item-"+d.visitorid),d=this.$win0.querySelector("#chat-tab-item-"+a+" a"),c&&c.classList.remove("is--new"),d&&(d.classList.remove("badge"),d.removeAttribute("data-badge")))}};
nightBird.prototype.renderEmail=function(a){return a?'<a href="mailto:'+a+'">'+a+"</a>":'<span class="lcx-desc __lcx-no-email">'+this.str.noEmail+"</span>"};
nightBird.prototype._getChatTabContent=function(a){var b=document.getElementById("__win-tpl-chat-content"),c=document.createElement("div"),d="lcx-chat-tab-"+a,e=this.db.$_chats[a],f=this.db.$_msgs[a];if(e){c.id=d;c.className="lcx-chat-tab "+d;c.innerHTML=NBird.replaceAll(b.innerHTML,e,a,"chat-");if(b=b.getAttribute("data-classes"))c.className+=" "+b;b=c.querySelector(".lcx-msgs");b.id="lcx-msgs-"+a;if(f)for(var h in f)f=this.db.$_msgs[a][h],this.renderMsg(h,f,b,f.prevId);return c}};
nightBird.prototype.listenChatTab=function(a){var b=this.$win0.querySelector(".chat-tab-item.active"),c=this.$win0.querySelector(".lcx-chat-tab.active"),d=document.getElementById("chat-tab-item-"+a),e=document.getElementById("lcx-chat-tab-"+a);this._chatid=a;b&&(b.classList.remove("active"),c.classList.remove("active"));d.classList.add("active");e.classList.add("active");b=sessionStorage.getItem("nbird-reply-"+a)||"";this.$win0.querySelector(".nbird-reply").innerHTML=b;this.refreshChatWin(a);NBird.scrollDown(e.querySelector(".lcx-msgs-container"))};
nightBird.prototype.getChatWin=function(a){var b=document.createElement("ul"),c=document.createElement("div"),d=document.createElement("div"),e=this._chatGroups[a],f=document.getElementById("__win-tpl-chat"),h=document.getElementById("__win-tpl-chat-sidebar").innerHTML,g=this.db.$_users[a];g.phone=g.phone?g.phone:'<span class="text-gray-light">N/A</span>';g.companyName=g.companyName?g.companyName:'<span class="text-gray-light">N/A</span>';this._chatids=e;g.currentPageUrl&&(g.currentPageUrlClean=g.currentPageUrl.replace(this.opts._siteurl,
""));h=NBird.replaceAll(h,g,a,"user-");c.innerHTML=f.innerHTML;d.innerHTML=h;f=0;for(var l in e)b.insertAdjacentHTML("afterbegin",this.getChatTabItem(l).innerHTML),c.querySelector(".lcx-chat-tabs").appendChild(this._getChatTabContent(l)),f++;c.querySelector(".win-tabs").innerHTML=b.innerHTML;this.refreshUser(a,g);return{main:c.innerHTML,sidebar:d.innerHTML}};
nightBird.prototype.getChatTabItem=function(a){var b=this.db.$_chats[a],c=document.createElement("div"),d=document.createElement("li");d.id="chat-tab-item-"+a;d.className="tab-item chat-tab-item chat-tab-item-"+a;d.setAttribute("data-status",b.status);d.innerHTML='<a href="#'+a+'">'+b.caseNo+"</a>";c.appendChild(d);return c};
nightBird.prototype.listenChatItem=function(a,b){var c=this;-1===this._listenItems.indexOf(a)&&(this._listenItems.push(a),b.addEventListener("click",function(a){a.preventDefault();a=this.getAttribute("href").substring(1);var b=c.getChatWin(a);c.openWin("chat",a,b);a=this.parentNode.id;b=document.querySelector(".side-list a.active");this.classList.add("active");b&&b.parentNode.id!==a&&b.classList.remove("active");return!1}))};
nightBird.prototype.removeTab=function(a,b,c){if("chat"===a){if(!c)return;this._chatid===b&&(this._chatid="");c.visitorid in this._chatGroups||(this.removeItem("visitor",c.visitorid),this.closeWin());0===Object.keys(this._chatGroups).length&&this.$chats.querySelector("._no-item").classList.remove("d-hide")}NBird.delObj(a+"-tab-item-"+b);NBird.delObj("lcx-"+a+"-tab-"+b)};
nightBird.prototype.renderMsg=function(a,b,c,d){d=[];var e="console"===b.platform&&this.db._uid===b.uid,f=e?this.db.$_user:this.db.$_users[b.uid],h="lcx-msg-"+b.chatid+a;if(f&&c){a=document.createElement("li");a.id=h;d.push(h);e&&(d.push("lcx-msg--you"),b.name=this.str.you);b.photoURL||!f.nickname?e='<span class="lcx-avatar"><img src="'+(b.photoURL||this.opts.companyLogo||this.opts.anonymousImage)+'" alt="" /></span>':(e=f.color,(h=f.name.match(/\b(\w)/g))||(h=[f.name.charAt(0)]),h=h.join(""),h=2<
h.length?h.substring(0,2):h,e='<span class="lcx-avatar" style="color: '+NBird.idealTextColor(e)+";background-color:"+e+';">'+h+"</span>",d.push("lcx-msg--avatarText"));h=NBird.time(b.date,this.opts.hourFormat);var g=NBird.time(b.date,this.opts.dateFormat);a.className=d.join(" ");a.innerHTML='<div class="lcx-msg-wrap">'+e+'<div class="lcx-content"><div class="lcx-meta"><span class="lcx-msg-status"></span><span class="lcx-time" title="'+g+'">'+h+'</span></div><div class="lcx-author"><span class="lcx-title">'+
f.name+'</span><span class="lcx-desc"></span></div><span class="lcx-msg">'+NBird.renderMsg(b.msg)+"</span></div></div>";c.appendChild(a);NBird.scrollDown(c.parentNode)}};
nightBird.prototype.refreshUser=function(a,b){if(b){var c=document.getElementById("visitor-item-"+a);b.name=b.nickname||b.name;b.__emailForNtf=this.renderEmail(b.emailForNtf);b.phone=b.phone?b.phone:'<span class="text-gray-light">N/A</span>';b.companyName=b.companyName?b.companyName:'<span class="text-gray-light">N/A</span>';c&&(c.querySelector(".lcx-timeago").setAttribute("datetime",b.lastSeen/1E3),c.querySelector(".lcx-name").innerText=b.name,b.currentPageUrl&&(b.currentPageUrlClean=b.currentPageUrl.replace(this.opts._siteurl,
"")),NBird.refreshTags(a,b,"user-"));b.chatsAsVisitor&&b.sessions&&b.sessions.frontend?(this._onlineVisitors[a]=!0,c&&c.setAttribute("data-status","online")):(delete this._onlineVisitors[a],c&&c.setAttribute("data-status","offline"));this._win&&(c=this.$win1.querySelector(".user-info .nbird-username"))&&this._win.rawid===a&&(c.innerText=b.name);this.refreshChatWin(this._chatid)}};nightBird.prototype.closeModals=function(){document.querySelector(".modal-overlay").click()};
nightBird.prototype.saveSettings=function(a){var b=this;this.newNtf("info",this.str.saving,"settings");NBird.post("saveSettings",a,this.opts.ajax,function(c){c.error?console.error(c):b.db.updateProfile({name:a.name||b.db.getRandName(),photoURL:a.photoURL||""},function(){b.newNtf("success",b.str.saved,"settings",!0);b.$btnSaveProfile.disabled=!1})})};
nightBird.prototype._dbEvents=function(){this.event.on("setup",this._onSetup.bind(this));this.event.on("connect",this._onConnect.bind(this));this.event.on("disconnect",this._onDisconnect.bind(this));this.event.on("authState",this._onAuthState.bind(this));this.event.on("authError",this._onAuthErr.bind(this));this.event.on("endSession",this._onEndSession.bind(this));this.event.on("duplicateSession",this._onDuplicateSess.bind(this));this.event.on("newOp",this._onNewOp.bind(this));this.event.on("deleteOp",
this._onDeleteOp.bind(this));this.event.on("newUser",this._onNewUser.bind(this));this.event.on("updateUser",this._onUpdateUser.bind(this));this.event.on("deleteUser",this._onDeleteUser.bind(this));this.event.on("newChat",this._onNewChat.bind(this));this.event.on("updateChat",this._onUpdateChat.bind(this));this.event.on("deleteChat",this._onDeleteChat.bind(this));this.event.on("newArchivedChat",this._onNewArchivedChat.bind(this));this.event.on("updateArchivedChat",this._onUpdateArchivedChat.bind(this));
this.event.on("deleteArchivedChat",this._onDeleteArchivedChat.bind(this));this.event.on("newMsg",this._onNewMsg.bind(this));this.event.on("updateMsg",this._onUpdateMsg.bind(this));this.event.on("deleteMsg",this._onDeleteMsg.bind(this));this.event.on("newMember",this._onNewMember.bind(this));this.event.on("updateMember",this._onUpdateMember.bind(this));this.event.on("deleteMember",this._onDeleteMember.bind(this));this.event.on("profile",this._onProfileUpdate.bind(this))};
nightBird.prototype._onSetup=function(){document.body.setAttribute("data-auth-state","setup")};nightBird.prototype._onConnect=function(){document.body.setAttribute("data-conn-status","connect");this.$console.classList.remove("disabled");this.newNtf("success",this.str.connected,"auth",!0)};nightBird.prototype._onDisconnect=function(a){document.body.setAttribute("data-conn-status","disconnect");this.$console.classList.add("disabled");this.db._isFirstConn||this.newNtf("error",this.str.noConn,"auth")};
nightBird.prototype._onAuthState=function(a){a?(a="signedin",this.$toggleOnline.classList.remove("d-hide"),this.$btnProfile.classList.remove("d-hide"),this.db.listenOpEvents(),this.db.verify()):(a="signedout",this.$toggleOnline.classList.add("d-hide"),this.$btnProfile.classList.add("d-hide"),document.body.removeAttribute("data-online"),this.$switchOnline.checked=!1,document.getElementById("currentUser-name").innerHTML="&nbsp;",document.getElementById("currentUser-photoURL").src=this.opts.anonymousImage,
this.db._isFirstConn||window.location.reload(!0));this.$signin.setAttribute("data-status",a);this.$signin.disabled=!1;document.body.setAttribute("data-auth-state",a)};nightBird.prototype._onEndSession=function(){this._onDuplicateSess()};
nightBird.prototype._onDuplicateSess=function(a){var b=this;this.$console.classList.add("disabled");this.newNtf("error",this.str.errDuplicateSess+' <a href="#" id="nbird-use-here">'+this.str.useHere+"</a>","auth");(a=document.getElementById("nbird-use-here"))&&a.addEventListener("click",function(a){a.preventDefault();b.db.endSession(function(){window.location.reload(!0)})})};nightBird.prototype._onAuthErr=function(a){this.newNtf("error",a.message,"auth");this.$signin.disabled=!1};
nightBird.prototype._onProfileUpdate=function(a){var b=this.db.$_user;if(b){if(b.name&&b.email&&b.photoURL)var c={name:b.name,photoURL:b.photoURL,lastOnline:firebase.database.ServerValue.TIMESTAMP};else this.db.updateEmail(this.opts.user.email),this.db.updateProfile({name:this.opts.user.name,email:this.opts.user.email,photoURL:this.opts.user.photoURL}),c={name:this.opts.user.name,photoURL:this.opts.user.email,lastOnline:firebase.database.ServerValue.TIMESTAMP};this.db.db.ref("operators/"+a).set(c);
this._listenChats=b.chats?Object.keys(b.chats):[];document.getElementById("field-user-name").value=b.name||this.opts.user.name;document.getElementById("field-user-email").value=b.email||this.opts.user.email;document.getElementById("field-user-photo-url").value=b.photoURL||this.opts.user.photoURL;document.getElementById("currentUser-name").innerHTML=b.name||"&nbsp;";document.getElementById("currentUser-photoURL").src=b.photoURL||this.opts.anonymousImage}};
nightBird.prototype._onNewUser=function(a,b){this.refreshUser(a,b)};nightBird.prototype._onUpdateUser=function(a,b){this.refreshUser(a,b)};nightBird.prototype._onDeleteUser=function(a){this.refreshUser(a,null)};nightBird.prototype._onNewOp=function(a,b){this.db._uid===a&&(document.body.setAttribute("data-online",!0),this.$switchOnline.checked=!0)};nightBird.prototype._onDeleteOp=function(a,b){this.db._uid===a&&(document.body.removeAttribute("data-online"),this.$switchOnline.checked=!1)};
nightBird.prototype._onNewChat=function(a,b,c){var d=b.visitorid,e=sessionStorage.getItem("nbird-chatNotified-"+a);if(d){if(!this._chatGroups[d]){this._chatGroups[d]={};this._newChats[d]={};var f=this.db.$_users[d];f._status=f.sessions&&f.sessions.frontend?"online":"offline";this.createItem("visitor",d,f)}"init"===b.status&&(e||(sessionStorage.setItem("nbird-chatNotified-"+a,!0),this.newDeskNtf(this.str.newChat.replace("%s",b.name),"chat-started",b.subject,a,this.opts.ntfDuration,this.opts.companyLogo||
this.opts.systemImage)),this._newChats[b.visitorid][a]=!0,this.updateItem("newChat","visitor-item-"+b.visitorid));b.id=a;this._countNewMsgs[a]=0;this._chatGroups[b.visitorid][a]=!0;this._win.rawid===b.visitorid&&(a=this.getChatWin(d),this.openWin("chat",b.visitorid,a));this.refreshChat(d,b,c)}};
nightBird.prototype._onUpdateChat=function(a,b,c){var d=b.visitorid;b.id=a;this.refreshChat(d,b,c);"init"===b.status?this._newChats[d][a]=!0:this._newChats[d]&&this._newChats[d][a]&&delete this._newChats[d][a];a=this._newChats[d]&&0<Object.keys(this._newChats[d]).length?"newChat":"noNewChat";this.updateItem(a,"visitor-item-"+d)};
nightBird.prototype._onDeleteChat=function(a,b,c){c=b.visitorid;this._chatGroups[c]&&a in this._chatGroups[c]&&(delete this._chatGroups[c][a],0===Object.keys(this._chatGroups[c]).length&&delete this._chatGroups[c]);this._countNewMsgs[a]&&delete this._countNewMsgs[a];this._newChats[c][a]&&delete this._newChats[c][a];this._win.rawid===c&&this.removeTab("chat",a,b);c in this._chatGroups||NBird.delObj("visitor-item-"+c);a=this._newChats[c]&&0<Object.keys(this._newChats[c]).length?"newChat":"noNewChat";
this.updateItem(a,"visitor-item-"+c)};
nightBird.prototype._onNewArchivedChat=function(a,b,c){var d=this;this.$archivedChats.querySelector("._no-item").classList.add("d-hide");a=this.createItem("archivedChat",a,b);if(b=this.db.$_users[b.visitorid])NBird.timeago(a.querySelector(".lcx-timeago"),this.str.timeShort),a.querySelector(".lcx-name").innerText=b.nickname||b.name,a.querySelector(".lcx-undo-link").addEventListener("click",function(a){a.preventDefault();d.db.updateChat(this.getAttribute("href").substring(1),{archived:null})})};
nightBird.prototype._onUpdateArchivedChat=function(a,b,c){};nightBird.prototype._onDeleteArchivedChat=function(a,b,c){0===Object.keys(this.db._archives).length&&this.$archivedChats.querySelector("._no-item").classList.remove("d-hide");this.removeItem("archivedChat",a)};
nightBird.prototype._onNewMsg=function(a,b,c){if(this._win){if("chat"===this._win.type&&b.chatid in this._chatids){var d=document.getElementById("lcx-msgs-"+b.chatid);this.renderMsg(a,b,d,c)}b.__unread&&-1===this._listenChats.indexOf(b.chatid)&&(c=this.db.$_users[b.uid],d=this.db.$_chats[b.chatid],a=++this._countNewMsgs[b.chatid],this.newDeskNtf(this.str.newMsg.replace("%s",c.name),"msg",b.msg,b.chatid,this.opts.ntfDuration,c.photoURL||this.opts.companyLogo),c=document.getElementById("visitor-item-"+
d.visitorid),d=document.querySelector("#chat-tab-item-"+b.chatid+" a"),c&&c.classList.add("is--new"),d&&(d.classList.add("badge"),d.setAttribute("data-badge",a)),this._unreadChats.push(b.chatid))}};nightBird.prototype._onUpdateMsg=function(a,b,c){};nightBird.prototype._onDeleteMsg=function(a,b,c){NBird.delObj("lcx-msg-"+b.chatid+a)};nightBird.prototype._onNewMember=function(a,b,c){};nightBird.prototype._onUpdateMember=function(a,b,c){};nightBird.prototype._onDeleteMember=function(a,b,c){};
nightBird.prototype._onError=function(a){console.error(a)};
nightBird.prototype._onOpenWin=function(a,b){var c=this;if("chat"===a){for(var d=function(){var a=this.getAttribute("href").substring(1);sessionStorage.setItem("nbird-lastTab_"+c._win.rawid,a);c.listenChatTab(a)},e,f,h,g=this.$win0.getElementsByClassName("win-tabs"),l=sessionStorage.getItem("nbird-lastTab_"+this._win.rawid)||"",k=0;k<g.length;k++){e=g[k].getElementsByTagName("li");h=f="";for(var m=0;m<e.length;m++)f=e[m].querySelector("a"),f.addEventListener("click",d,!1),h=f.getAttribute("href").substring(1),
l===h?f.click():0===m&&f.click()}var n;f=function(){n=this;this.classList.add("disabled");w()};var w=function(){var a=c.db.$_chats[c._chatid];if(a){a.operatorName=c.db.$_user.name;var b=c.db.$_users[a.visitorid];if(b.chatsAsVisitor&&1===Object.keys(b.chatsAsVisitor).length)var d=(d=c.opts.welcomeMsg)?NBird.replace(c.opts.welcomeMsg,a,!0):"";c.db.joinChat(c._chatid,d,function(){n.classList.remove("disabled")})}};d=function(a){a.preventDefault();c.db.updateChat(c._chatid,{archived:!0})};k=function(a){a.preventDefault();
confirm(c.str.confirmDelete)&&c.db.deleteChat(c._chatid)};g=this.$win0.querySelectorAll(".btn-join-chat");h=this.$win0.querySelectorAll(".btn-archive-chat");e=this.$win0.querySelectorAll(".btn-delete-chat");l=$jscomp.makeIterator(g);for(g=l.next();!g.done;g=l.next())g=g.value,g.addEventListener("click",f,!1);f=$jscomp.makeIterator(h);for(g=f.next();!g.done;g=f.next())g=g.value,g.addEventListener("click",d,!1);d=$jscomp.makeIterator(e);for(g=d.next();!g.done;g=d.next())g=g.value,g.addEventListener("click",
k,!1);var r=!1,x=function(a,b){a=NBird.sanitizeMsg(a);c.db.pushMsg(c._chatid,a,b,c._onError)},t=this.$win0.querySelector(".nbird-reply");t.addEventListener("keydown",function(a){if(a&&13===a.keyCode&&!a.shiftKey&&!r){r=!0;var b=this.innerHTML;b?(this.innerText="",sessionStorage.removeItem("nbird-reply-"+c._chatid),c.readChat(c._chatid),x(b,function(){r=!1}),a.preventDefault()):r=!1}},!1);t.addEventListener("blur",function(){sessionStorage.setItem("nbird-reply-"+c._chatid,this.innerHTML)});if(d=this.$win0.getElementsByClassName("lcx-msgs-container"))for(k=
0;k<d.length;k++)d[k].addEventListener("mouseenter",function(a){c.readChat(c._chatid)});(function(a){t.classList.contains("trumbowyg-editor")||a(".nbird-reply").trumbowyg({btns:[["bold","italic"],["viewHTML","removeformat"]],autogrow:!0,removeformatPasted:!0})})(jQuery);k=this.db.$_chats[this._chatid];d=this.db.$_users[b];e=this.$win1.querySelector(".user-info .nbird-username-wrap");var p=this.$win1.querySelector(".user-info .nbird-username");p.innerText=d.nickname;var u=!1,v,q="";e.addEventListener("click",
function(){v=p.textContent;u||(p.focus(),NBird.selAll(p),u=!0)});p.addEventListener("blur",function(a){u=!1;q=p.textContent;q=q.trim();0===q.length?p.textContent=v:c.db.renameUser(b,q)});p.addEventListener("keydown",function(a){a&&13===a.keyCode&&!a.shiftKey&&(a.preventDefault(),p.blur())});this.event.emit("openChatWin",b,d,k)}this.refreshChatWin(b);this.actions(this.$win1)};